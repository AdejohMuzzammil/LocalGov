{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<h1 class="text-center">Local Government Works</h1>
<p class="text-center">View recent posts by chairmen from different states and local governments in Nigeria</p>

<div class="posts-list">
    {% for post in posts %}
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <div>
                <h5 class="card-title">{{ post.title }}</h5>
                <p><strong>State:</strong> {{ post.state.name }} | <strong>Local Government:</strong> {{ post.local_government.name }}</p>
                <p><strong>Location:</strong> {{ post.location }}</p>
                <p class="text-muted">{{ post.date_posted|date:"F j, Y" }}</p>
            </div>
            {% if post.image %}
            <img src="{{ post.image.url }}" alt="Image for {{ post.title }}" class="img-thumbnail" style="width: 100px; height: auto;">
            {% endif %}
        </div>

        <div class="card-body">
            {% if post.video %}
            <video controls class="card-img-top" style="width: 100%; height: 370px;">
                <source src="{{ post.video.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            {% endif %}
            <p class="card-text">{{ post.description }}</p>

            <!-- Map Section -->
            {% if post.latitude and post.longitude %}
            <div class="map-container mt-3">
                <h6>Location Map</h6>
                <div id="map-{{ forloop.counter }}" style="width: 100%; height: 300px;"></div>
                <script>
                    function initMap{{ forloop.counter }}() {
                        var location = { lat: {{ post.latitude }}, lng: {{ post.longitude }} };
                        var map = new google.maps.Map(document.getElementById("map-{{ forloop.counter }}"), {
                            zoom: 10,
                            center: location
                        });
                        new google.maps.Marker({
                            position: location,
                            map: map
                        });
                    }
                    google.maps.event.addDomListener(window, 'load', initMap{{ forloop.counter }});
                </script>
            </div>
            {% endif %}
        </div>

        <!-- Comments Section -->
        <div class="card-footer">
            <button class="btn btn-sm btn-primary" onclick="toggleComments({{ post.id }})">
                <i class="fas fa-comment"></i> Comments
            </button>

            <!-- Comments Section, hidden by default -->
            <div id="comments-{{ post.id }}" class="comments-section mt-3" style="display: none;">
                <h6>Comments</h6>
                <div id="comments-container-{{ post.id }}">
                    {% for comment in post.comments.all %}
                    <div class="comment" id="comment-{{ comment.id }}">
                        <strong>{{ comment.user.username }}</strong>: {{ comment.text }}
                        <span class="text-muted">{{ comment.date_commented|date:"F j, Y" }}</span>

                        <button onclick="likeComment({{ comment.id }})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #28a745; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                            <i class="fas fa-thumbs-up" style="margin-right: 5px;"></i> 
                        </button>
                        
                        <button onclick="dislikeComment({{ comment.id }})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #dc3545; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                            <i class="fas fa-thumbs-down" style="margin-right: 5px;"></i> 
                        </button>
                        
                        <button onclick="deleteComment({{ comment.id }})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #ffc107; color: black; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                            <i class="fas fa-trash" style="margin-right: 5px;"></i> Delete
                        </button>


                        <!-- Replies Section -->
                        <div class="replies">
                            {% for reply in comment.replies.all %}
                            <div class="reply" id="reply-{{ reply.id }}">
                                <strong>{{ reply.user.username }}</strong>: {{ reply.text }}
                                <span class="text-muted">{{ reply.date_commented|date:"F j, Y" }}</span>
                                <button onclick="likeReply({{ reply.id }})">Like</button>
                                <button onclick="dislikeReply({{ reply.id }})">Dislike</button>
                                <button onclick="deleteReply({{ reply.id }})">Delete</button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Comment Input -->
                <textarea id="comment-text-{{ post.id }}" class="form-control mt-2" placeholder="Write a comment..."></textarea>
                <button onclick="addComment({{ post.id }})" style="background-color: #007bff; color: white; border: none; border-radius: 4px; padding: 6px 10px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center;">
                    <i class="fas fa-comment" style="margin-right: 4px;"></i> Comment
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    // Function to toggle the visibility of the comments section
    function toggleComments(postId) {
        const commentsSection = document.getElementById(`comments-${postId}`);
        if (commentsSection) {
            commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
        }
    }

    // Add Comment
    function addComment(postId) {
        const commentText = document.getElementById(`comment-text-${postId}`).value;
    
        $.ajax({
            type: 'POST',
            url: `/post/${postId}/add_comment/`,
            data: {
                text: commentText,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    const newComment = `<div class="comment" id="comment-${response.comment_id}">
                        <strong>${response.username}</strong>: ${response.text}
                        <span class="text-muted">${response.date}</span>
    
                        <button onclick="likeComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #28a745; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                            <i class="fas fa-thumbs-up" style="margin-right: 5px;"></i> 
                        </button>
                        <button onclick="dislikeComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #dc3545; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                            <i class="fas fa-thumbs-down" style="margin-right: 5px;"></i> 
                        </button>
                        <button onclick="deleteComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #ffc107; color: black; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                            <i class="fas fa-trash" style="margin-right: 5px;"></i> Delete
                        </button>
                        
                    </div>`;
                    $(`#comments-container-${postId}`).prepend(newComment);
                    document.getElementById(`comment-text-${postId}`).value = '';
                }
            }
        });
    }
    
    // Like, Dislike, and Delete Comment Functions
    function likeComment(commentId) {
        $.ajax({
            type: 'POST',
            url: `{% url 'like_comment' 0 %}`.replace('0', commentId),
            data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function(response) {
                if (response.status === 'success') {
                    $(`#comment-${commentId} .like-count`).text(response.like_count);
                }
            }
        });
    }

    function dislikeComment(commentId) {
        $.ajax({
            type: 'POST',
            url: `{% url 'dislike_comment' 0 %}`.replace('0', commentId),
            data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function(response) {
                if (response.status === 'success') {
                    $(`#comment-${commentId} .dislike-count`).text(response.dislike_count);
                }
            }
        });
    }

    function deleteComment(commentId) {
        $.ajax({
            type: 'POST',
            url: `{% url 'delete_comment' 0 %}`.replace('0', commentId),
            data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function(response) {
                if (response.status === 'success') {
                    $(`#comment-${commentId}`).remove();
                } else {
                    alert(response.message);
                }
            }
        });
    }

    // Like, Dislike, and Delete Reply Functions
    function likeReply(replyId) {
        $.ajax({
            type: 'POST',
            url: `{% url 'like_reply' 0 %}`.replace('0', replyId),
            data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function(response) {
                if (response.status === 'success') {
                    $(`#reply-${replyId} .like-count`).text(response.like_count);
                }
            }
        });
    }

    function dislikeReply(replyId) {
        $.ajax({
            type: 'POST',
            url: `{% url 'dislike_reply' 0 %}`.replace('0', replyId),
            data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function(response) {
                if (response.status === 'success') {
                    $(`#reply-${replyId} .dislike-count`).text(response.dislike_count);
                }
            }
        });
    }

    function deleteReply(replyId) {
        $.ajax({
            type: 'POST',
            url: `{% url 'delete_reply' 0 %}`.replace('0', replyId),
            data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function(response) {
                if (response.status === 'success') {
                    $(`#reply-${replyId}`).remove();
                } else {
                    alert(response.message);
                }
            }
        });
    }

    // Load Comments
    function loadComments(postId) {
        $.ajax({
            type: 'GET',
            url: `{% url 'load_comments' 0 %}`.replace('0', postId),
            success: function(response) {
                if (response.status === 'success') {
                    $(`#comments-container-${postId}`).html(response.comments_html);
                }
            }
        });
    }
</script>
{% endblock %}
