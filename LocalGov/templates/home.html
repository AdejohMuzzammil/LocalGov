{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<h1 class="text-center">Local Government Works</h1>
<p class="text-center">View recent posts by chairmen from different states and local governments in Nigeria</p>


<div class="posts-list">
    <!-- Posts Section -->
    {% for post in posts %}
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <div>
                <h5 class="card-title">{{ post.title }}</h5>
                <p><strong>State:</strong> {{ post.state.name }} | <strong>Local Government:</strong> {{ post.local_government.name }}</p>
                <p><strong>Location:</strong> {{ post.location }}</p>
                <p class="text-muted">{{ post.date_posted|date:"F j, Y" }}</p>
            </div>
            {% if post.image %}
                <img src="{{ post.image.url }}" alt="Image for {{ post.title }}" class="img-thumbnail" style="width: 100px; height: auto;">
            {% endif %}
        </div>

        <div class="card-body">
            {% if post.video %}
                <video controls class="card-img-top" style="width: 100%; height: 370px;">
                    <source src="{{ post.video.url }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            {% endif %}
            <p class="card-text">{{ post.description }}</p>

            <!-- Map Section -->
            {% if post.latitude and post.longitude %}
            <div class="map-container mt-3">
                <h6>Location Map</h6>
                <div id="map-{{ post.id }}" style="width: 100%; height: 300px;"></div>
                <script>
                    function initMap{{ post.id }}() {
                        var location = { lat: {{ post.latitude }}, lng: {{ post.longitude }} };
                        var map = new google.maps.Map(document.getElementById("map-{{ post.id }}"), {
                            zoom: 10,
                            center: location
                        });
                        new google.maps.Marker({
                            position: location,
                            map: map
                        });
                    }
                    google.maps.event.addDomListener(window, 'load', initMap{{ post.id }});
                </script>
            </div>
            {% endif %}
        </div>

      <!-- Comments Section -->
    <div class="card-footer">
        <button class="btn btn-sm btn-primary" onclick="toggleComments({{ post.id }})">
            <i class="fas fa-comment"></i> Comments
        </button>

        <div id="comments-{{ post.id }}" class="comments-section mt-3" style="display: none;">
            <h6>Comments</h6>

            {% if user.is_authenticated %}
                <div id="comments-container-{{ post.id }}">
                    {% for comment in post.comments.all %}
                        <div class="comment" id="comment-{{ comment.id }}" style="padding-bottom: 10px; margin-bottom: 15px;">
                            <strong>{{ comment.user.username }}</strong>: {{ comment.text }}
                            <span class="text-muted" style="font-size: 0.9em;">{{ comment.date_commented|date:"F j, Y" }}</span>

                            <div style="margin-top: 10px;">
                                <button onclick="likeComment({{ comment.id }})" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px; margin-right: 5px;">
                                    <i class="fas fa-thumbs-up"></i> <span class="comment-like-count">{{ comment.like_count.count }}</span>
                                </button>

                                <button onclick="dislikeComment({{ comment.id }})" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px; margin-right: 5px;">
                                    <i class="fas fa-thumbs-down"></i> <span class="comment-dislike-count">{{ comment.dislike_count.count }}</span>
                                </button>

                                {% if comment.user == user %}
                                    <button onclick="deleteComment({{ comment.id }})" style="background-color: #ffc107; color: black; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px; margin-right: 5px;">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                {% endif %}

                                <button onclick="toggleReplyForm({{ comment.id }})" style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px;">
                                    <i class="fas fa-reply"></i> Reply
                                </button>
                            </div>

                            <!-- Reply Form (Initially hidden) -->
                            <div id="reply-form-{{ comment.id }}" style="display: none; margin-top: 10px;">
                                <div class="input-group" style="border-radius: 20px; overflow: hidden; display: flex; align-items: center;">
                                    <!-- Textarea with enhanced styling to align with the button -->
                                    <textarea 
                                        id="reply-text-{{ comment.id }}" 
                                        class="form-control" 
                                        placeholder="Write a reply..." 
                                        style="border-radius: 25px; font-size: 1em; padding: 10px 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border: 1px solid #ddd; height: 50px; resize: none; flex-grow: 1;">
                                    </textarea>
                                    
                                    <button 
                                        onclick="addReply({{ comment.id }})" 
                                        class="btn btn-primary" 
                                        style="display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 1.2em; width: 50px; height: 50px; padding: 0; background-color: #fcdc56; border: none; margin-left: 10px; outline: none;">
                                        <i class="fas fa-paper-plane" style="color: white;"></i>
                                    </button>
                                </div>
                            </div>
                            

                            <!-- Replies Section -->
                            <div class="replies" style="margin-top: 10px;">
                                {% for reply in comment.replies.all %}
                                    <div class="reply" id="reply-{{ reply.id }}" style="margin-bottom: 10px;">
                                        <strong>{{ reply.user.username }}</strong>: {{ reply.text }}
                                        <span class="text-muted" style="font-size: 0.85em;">{{ reply.date_commented|date:"F j, Y" }}</span>

                                        <div style="margin-top: 5px;">
                                            <button onclick="likeReply({{ reply.id }})" style="background-color: #28a745; color: white; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px; margin-right: 5px;">
                                                <i class="fas fa-thumbs-up"></i> <span class="reply-like-count">{{ reply.like_count.count }}</span>
                                            </button>

                                            <button onclick="dislikeReply({{ reply.id }})" style="background-color: #dc3545; color: white; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px; margin-right: 5px;">
                                                <i class="fas fa-thumbs-down"></i> <span class="reply-dislike-count">{{ reply.dislike_count.count }}</span>
                                            </button>

                                            {% if reply.user == user %}
                                                <button onclick="deleteReply({{ reply.id }})" style="background-color: #ffc107; color: black; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px;">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <hr style="border: 1px solid #ddd; margin-top: 15px;">
                        </div>
                    {% endfor %}
                </div>

            <!-- Comment Input -->
                <div class="input-group" style="margin-top: 10px; display: flex; align-items: center; border-radius: 20px; overflow: hidden;">
                    <!-- Textarea with increased border-radius and improved styling -->
                    <textarea id="comment-text-{{ post.id }}" class="form-control" 
                            style="border-radius: 25px; font-size: 1em; padding: 12px; min-height: 40px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border: 1px solid #ddd; resize: none; flex-grow: 1;"
                            placeholder="Write a comment..." oninput="resizeTextarea(this)"></textarea>
                    
                    <!-- Comment Button with paper-plane icon, green background, and white icon -->
                    <button id="comment-button-{{ post.id }}" onclick="addComment({{ post.id }})" class="btn btn-primary" 
                            style="border-radius: 50%; font-size: 1.2em; padding: 10px; background-color: transparent; border: none; transition: transform 0.2s, box-shadow 0.2s;"
                            onfocus="this.style.backgroundColor='#6c757d';" onblur="this.style.backgroundColor='transparent';">
                        <i class="fas fa-paper-plane" style="color: white; background-color: #28a745; border-radius: 50%; padding: 12px;"></i>
                    </button>
                </div>

            {% else %}
                <p>You must <a href="{% url 'login' %}">log in</a> to comment.</p>
            {% endif %}
        </div>
    </div>

    </div>
    {% endfor %}

    <!-- Approved Posts Section -->
    {% for post in approved_posts %}
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <div>
                <h5 class="card-title">{{ post.title }}</h5>
                <p><strong>State:</strong> {{ post.state.name }} | <strong>Local Government:</strong> {{ post.local_government.name }}</p>
                <p><strong>Location:</strong> {{ post.location }}</p>
                <p class="text-muted">{{ post.date_posted|date:"F j, Y" }}</p>
            </div>
            {% if post.image %}
                <img src="{{ post.image.url }}" alt="Image for {{ post.title }}" class="img-thumbnail" style="width: 100px; height: auto;">
            {% endif %}
        </div>

        <div class="card-body">
            {% if post.video %}
                <video controls class="card-img-top" style="width: 100%; height: 370px;">
                    <source src="{{ post.video.url }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            {% endif %}
            <p class="card-text">{{ post.description }}</p>

            <!-- Map Section -->
            {% if post.latitude and post.longitude %}
            <div class="map-container mt-3">
                <h6>Location Map</h6>
                <div id="map-{{ post.id }}" style="width: 100%; height: 300px;"></div>
                <script>
                    function initMap{{ post.id }}() {
                        var location = { lat: {{ post.latitude }}, lng: {{ post.longitude }} };
                        var map = new google.maps.Map(document.getElementById("map-{{ post.id }}"), {
                            zoom: 10,
                            center: location
                        });
                        new google.maps.Marker({
                            position: location,
                            map: map
                        });
                    }
                    google.maps.event.addDomListener(window, 'load', initMap{{ post.id }});
                </script>
            </div>
            {% endif %}

        </div>

        
        <!-- Comments Section -->
        <div class="card-footer">
            <button class="btn btn-sm btn-primary" onclick="toggleStaffComments({{ post.id }})">
                <i class="fas fa-comment"></i> Comments
            </button>

            <div id="comments-{{ post.id }}" class="comments-section mt-3" style="display: none;">
                <h6>Comments</h6>

                {% if user.is_authenticated %}
                    <div id="comments-container-{{ post.id }}">
                        {% for comment in post.staff_comments.all %}
                            <div class="comment" id="comment-{{ comment.id }}" style="padding-bottom: 10px; margin-bottom: 15px;">
                                <strong>{{ comment.user.username }}</strong>: {{ comment.text }}
                                <span class="text-muted" style="font-size: 0.9em;">{{ comment.date_commented|date:"F j, Y" }}</span>

                                <div style="margin-top: 10px;">
                                    <button onclick="likeStaffComment({{ comment.id }})" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px; margin-right: 5px;">
                                        <i class="fas fa-thumbs-up"></i> <span class="comment-like-count">{{ comment.like_count.count }}</span>
                                    </button>

                                    <button onclick="dislikeStaffComment({{ comment.id }})" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px; margin-right: 5px;">
                                        <i class="fas fa-thumbs-down"></i> <span class="comment-dislike-count">{{ comment.dislike_count.count }}</span>
                                    </button>

                                    {% if comment.user == user %}
                                        <button onclick="deleteStaffComment({{ comment.id }})" style="background-color: #ffc107; color: black; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px; margin-right: 5px;">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    {% endif %}

                                    <button onclick="toggleStaffReplyForm({{ comment.id }})" style="background-color: #fcdc56; border: none; padding: 10px; font-size: 0.85em; border-radius: 50%; margin-right: 5px;">
                                        <i class="fas fa-paper-plane" style="color: white;"></i> Reply
                                    </button>
                                </div>

                                <!-- Reply Form (Initially hidden) -->
                                <div id="reply-form-{{ comment.id }}" style="display: none; margin-top: 10px;">
                                    <!-- Comment textarea and reply button on the same line -->
                                    <div style="display: flex; align-items: center;">
                                        <textarea id="reply-text-{{ comment.id }}" style="width: 80%; padding: 8px; font-size: 0.85em; border-radius: 25px; margin-right: 10px; border: 1px solid #ccc;" placeholder="Write a reply..."></textarea>
                                        <button onclick="addStaffReply({{ comment.id }})" style="background-color: #fcdc56; color: white; border: none; padding: 12px; font-size: 0.85em; border-radius: 50%;">
                                            <i class="fas fa-paper-plane" style="color: white;"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Replies Section -->
                                <div id="replies-{{ comment.id }}" class="replies" style="margin-top: 10px;">
                                    {% for reply in comment.staff_replies.all %}
                                        <div class="reply" id="reply-{{ reply.id }}" style="margin-bottom: 10px;">
                                            <strong>{{ reply.user.username }}</strong>: {{ reply.text }}
                                            <span class="text-muted" style="font-size: 0.85em;">{{ reply.date_commented|date:"F j, Y" }}</span>

                                            <div style="margin-top: 5px;">
                                                <button onclick="likeStaffReply({{ reply.id }})" style="background-color: #28a745; color: white; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px; margin-right: 5px;">
                                                    <i class="fas fa-thumbs-up"></i> <span class="reply-like-count">{{ reply.like_count.count }}</span>
                                                </button>

                                                <button onclick="dislikeStaffReply({{ reply.id }})" style="background-color: #dc3545; color: white; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px; margin-right: 5px;">
                                                    <i class="fas fa-thumbs-down"></i> <span class="reply-dislike-count">{{ reply.dislike_count.count }}</span>
                                                </button>

                                                {% if reply.user == user %}
                                                    <button onclick="deleteStaffReply({{ reply.id }})" style="background-color: #ffc107; color: black; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px;">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>

                                <hr style="border: 1px solid #ddd; margin-top: 15px;">
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Comment Input -->
                    <div style="display: flex; align-items: center;">
                        <textarea id="comment-text-{{ post.id }}" style="width: 80%; padding: 8px; font-size: 0.9em; margin-top: 10px; border-radius: 25px; margin-right: 10px; border: 1px solid #ccc;" placeholder="Write a comment..."></textarea>
                        <button onclick="addStaffComment({{ post.id }})" style="background-color: #28a745; color: white; border: none; padding: 12px; font-size: 0.85em; border-radius: 50%;">
                            <i class="fas fa-paper-plane" style="color: white;"></i>
                        </button>
                    </div>
                {% else %}
                    <p><a href="{% url 'login' %}">Log in</a> to post a comment or reply.</p>
                {% endif %}
            </div>
        </div>




    </div>
    {% endfor %}

</div>


<script>

    // Function to resize the textarea as the user types (expands upwards)
    function resizeTextarea(textarea) {
        textarea.style.height = 'auto';  
        textarea.style.height = (textarea.scrollHeight) + 'px';  
    }

    // Reinitialize Reply Button and Form Toggling
    function reinitializeReplyForms() {
        $(document).off('click', '.reply-button').on('click', '.reply-button', function() {
            const commentId = $(this).data('comment-id');
            $(`#reply-form-${commentId}`).toggle(); 
        });
    }

    // Function to toggle the visibility of the comments section
    function toggleComments(postId) {
        const commentsSection = document.getElementById(`comments-${postId}`);
        if (commentsSection) {
            commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
        }
    }

    function toggleReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        // Toggle the visibility of the reply form
        replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
    }
    
    // Add Comment Function 
    function addComment(postId) {
        const commentText = document.getElementById(`comment-text-${postId}`).value.trim();
        const button = document.getElementById(`comment-button-${postId}`);

        // If the comment text is empty, do not proceed
        if (!commentText) {
            alert("Comment cannot be empty!");
            return;
        }

        // Simulate button press effect with smooth transition
        button.style.transform = 'scale(0.95)';
        button.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.2)';
        button.style.transition = 'transform 0.1s ease, box-shadow 0.1s ease';

        // Perform AJAX POST request
        $.ajax({
            type: 'POST',
            url: `/post/${postId}/add_comment/`,
            data: {
                text: commentText,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Create the new comment element
                    const newComment = `
                        <div class="comment" id="comment-${response.comment_id}" style="display: none;">
                            <strong>${response.username}</strong>: ${response.text}
                            <span class="text-muted">${response.date}</span>
                            
                            <!-- Like Button -->
                            <button onclick="likeComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #28a745; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-thumbs-up" style="margin-right: 5px;"></i>
                            </button>

                            <!-- Dislike Button -->
                            <button onclick="dislikeComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #dc3545; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-thumbs-down" style="margin-right: 5px;"></i>
                            </button>

                            <!-- Delete Button -->
                            <button onclick="deleteComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #ffc107; color: black; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-trash" style="margin-right: 5px;"></i> Delete
                            </button>

                                <!-- Reply Button -->
                            <button class="reply-button btn btn-secondary btn-sm" onclick="toggleReplyForm(${response.comment_id})">
                                <i class="fas fa-reply"></i> Reply
                            </button>

                            <!-- Reply Form -->
                            <div id="reply-form-${response.comment_id}" style="display: none; margin-top: 10px;">
                                <div class="input-group" style="border-radius: 20px; overflow: hidden;">
                                    <textarea id="reply-text-${response.comment_id}" class="form-control" placeholder="Write a reply..." style="border-radius: 25px; font-size: 1em; padding: 12px; min-height: 40px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border: 1px solid #ddd;"></textarea>
                                    <button onclick="addReply(${response.comment_id})" class="btn btn-primary" style="border-radius: 50%; font-size: 1.2em; padding: 12px; background-color: transparent; border: none;">
                                        <i class="fas fa-paper-plane" style="color: white; background-color: #fcdc56; border-radius: 50%; padding: 12px;"></i>
                                    </button>
                                </div>
                            </div>
                        </div>`;

                    // Append the new comment and animate its appearance
                    $(`#comments-container-${postId}`).prepend(newComment);
                    $(`#comment-${response.comment_id}`).fadeIn("slow");

                    // Clear the input field and reset the button appearance
                    document.getElementById(`comment-text-${postId}`).value = '';
                    button.style.transform = 'scale(1)';
                    button.style.boxShadow = 'none';
                } else {
                    alert("Failed to add comment. Please try again.");
                }
            },
            error: function() {
                alert("An error occurred while adding the comment.");
                // Reset the button appearance in case of error
                button.style.transform = 'scale(1)';
                button.style.boxShadow = 'none';
            }
        });
    }

    function addReply(commentId) {
        // Get the reply text from the textarea
        const replyText = document.getElementById(`reply-text-${commentId}`).value;
    
        // Make an AJAX POST request to add the reply
        $.ajax({
            type: 'POST',
            url: `/post/${commentId}/add_reply/`, // URL path for adding the reply
            data: {
                text: replyText,  // The reply text
                csrfmiddlewaretoken: '{{ csrf_token }}' // CSRF token for security
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Create the new reply element to display on the page
                    const newReply = `
                        <div class="reply" id="reply-${response.reply_id}" style="display: none;">
                            <strong>${response.username}</strong>: ${response.text}
                            <span class="text-muted">${response.date}</span>
    
                            <button onclick="likeReply(${response.reply_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #28a745; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-thumbs-up" style="margin-right: 5px;"></i> 
                            </button>
    
                            <button onclick="dislikeReply(${response.reply_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #dc3545; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-thumbs-down" style="margin-right: 5px;"></i> 
                            </button>
    
                            <button onclick="deleteReply(${response.reply_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #ffc107; color: black; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-trash" style="margin-right: 5px;"></i> Delete
                            </button>
                        </div>`;
    
                    // Append the new reply under the respective comment's reply section
                    $(`#reply-form-${commentId}`).before(newReply);
    
                    // Fade in the new reply
                    $(`#reply-${response.reply_id}`).fadeIn();
    
                    // Clear the reply textarea
                    document.getElementById(`reply-text-${commentId}`).value = '';
                }
            }
        });
    }
    
    // Like and Dislike Comment Functions
    function likeComment(commentId) {
        $.ajax({
            url: `/like_comment/${commentId}/`,
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Update the like and dislike counts for the comment
                    $(`#comment-${commentId} .comment-like-count`).text(response.like_count);
                    $(`#comment-${commentId} .comment-dislike-count`).text(response.dislike_count);
                } else {
                    alert('An error occurred while liking the comment.');
                }
            },
            error: function() {
                alert('An error occurred while processing your request.');
            }
        });
    }

    function dislikeComment(commentId) {
        $.ajax({
            url: `/dislike_comment/${commentId}/`,
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Update the like and dislike counts for the comment
                    $(`#comment-${commentId} .comment-like-count`).text(response.like_count);
                    $(`#comment-${commentId} .comment-dislike-count`).text(response.dislike_count);
                } else {
                    alert('An error occurred while disliking the comment.');
                }
            },
            error: function() {
                alert('An error occurred while processing your request.');
            }
        });
    }
        
    function deleteComment(commentId) {
        $.ajax({
            type: 'POST',
            url: `{% url 'delete_comment' 0 %}`.replace('0', commentId),
            data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function(response) {
                if (response.status === 'success') {
                    // Fade out the comment slowly before removing it from the DOM
                    $(`#comment-${commentId}`).fadeOut("slow", function() {
                        // Once the fadeOut is complete, remove the comment from the DOM
                        $(this).remove();
                    });
                } else {
                    alert(response.message);
                }
            }
        });
    }
    
 // Like and Dislike Reply Functions
    function likeReply(replyId) {
        $.ajax({
            url: `/like_reply/${replyId}/`,
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Update the like and dislike counts for the reply
                    $(`#reply-${replyId} .reply-like-count`).text(response.like_count);
                    $(`#reply-${replyId} .reply-dislike-count`).text(response.dislike_count);
                } else {
                    alert('An error occurred while liking the reply.');
                }
            },
            error: function() {
                alert('An error occurred while processing your request.');
            }
        });
    }

    function dislikeReply(replyId) {
        $.ajax({
            url: `/dislike_reply/${replyId}/`,
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Update the like and dislike counts for the reply
                    $(`#reply-${replyId} .reply-like-count`).text(response.like_count);
                    $(`#reply-${replyId} .reply-dislike-count`).text(response.dislike_count);
                } else {
                    alert('An error occurred while disliking the reply.');
                }
            },
            error: function() {
                alert('An error occurred while processing your request.');
            }
        });
    }

    function deleteReply(replyId) {
        $.ajax({
            type: 'POST',
            url: `{% url 'delete_reply' 0 %}`.replace('0', replyId),
            data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function(response) {
                if (response.status === 'success') {
                    $(`#reply-${replyId}`).fadeOut("slow", function() {
                        $(this).remove();
                    });
                } else {
                    alert(response.message);
                }
            }
        });
    }
    
    // Load Comments
    function loadComments(postId) {
        $.ajax({
            type: 'GET',
            url: `{% url 'load_comments' 0 %}`.replace('0', postId),
            success: function(response) {
                if (response.status === 'success') {
                    $(`#comments-container-${postId}`).html(response.comments_html);
                }
            }
        });
    }




    
    // Staffpost comment handling section
    function toggleStaffComments(postId) {
        var commentsSection = document.getElementById('comments-' + postId);
        commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
    }

    function toggleStaffReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        // Toggle the visibility of the reply form
        replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
    }

    // Function to add a new comment
    function addStaffComment(postId) {
        var commentText = document.getElementById('comment-text-' + postId).value;
        if (commentText.trim() === '') {
            alert('Comment cannot be empty.'); // Alert user for empty input
            return;
        }

        $.ajax({
            url: `/add_staff_comment/${postId}/`,
            type: 'POST',
            data: {
                'comment_text': commentText,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response) {
                if (response.success) {
                    const newComment = `
                        <div class="comment" id="comment-${response.comment_id}">
                            <strong>${response.username}</strong>: ${response.text}
                            <span class="text-muted">${response.date}</span>

                            <button onclick="likeStaffComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #28a745; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-thumbs-up" style="margin-right: 5px;"></i>
                            </button>

                            <button onclick="dislikeStaffComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #dc3545; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-thumbs-down" style="margin-right: 5px;"></i>
                            </button>

                            <button onclick="deleteStaffComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #ffc107; color: black; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-trash" style="margin-right: 5px;"></i> Delete
                            </button>

                            <button onclick="toggleReplyForm(${response.comment_id})" class="btn btn-secondary btn-sm">
                                <i class="fas fa-reply"></i> Reply
                            </button>

                            <!-- Comment Reply Form (Initially hidden) -->
                            <div id="reply-form-${response.comment_id}" style="display: none;">
                                <textarea id="reply-text-${response.comment_id}" class="form-control" placeholder="Write a reply..."></textarea>
                                <button onclick="addStaffReply(${response.comment_id})" class="btn btn-primary btn-sm">Reply</button>
                            </div>
                        </div>`;

                    // Prepend the new comment to the comments container
                    $(`#comments-container-${postId}`).prepend(newComment);

                    // Use fadeIn to animate the new comment
                    $(`#comment-${response.comment_id}`).hide().fadeIn("slow");

                    // Clear the input field after posting
                    document.getElementById('comment-text-' + postId).value = '';
                } else {
                    alert('Failed to add comment: ' + response.message); // Alert user on failure
                }
            },
            error: function(xhr, status, error) {
                alert('An error occurred while adding the comment.'); // General error alert
            }
        });
    }

    // Function to like a comment
    function likeStaffComment(commentId) {
        $.ajax({
            url: `/staff_like_comment/${commentId}/`, // Corrected the URL structure
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response) {
                if (response.success) {
                    var likeCount = $('.comment-like-count', '#comment-' + commentId);
                    likeCount.text(response.likeCount);
                }
            }
        });
    }

    // Function to dislike a comment
    function dislikeStaffComment(commentId) {
        $.ajax({
            url: `/staff_dislike_comment/${commentId}/`, // Corrected the URL structure
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response) {
                if (response.success) {
                    var dislikeCount = $('.comment-dislike-count', '#comment-' + commentId);
                    dislikeCount.text(response.dislikeCount);
                }
            }
        });
    }

    // Function to like a reply
    function likeStaffReply(replyId) {
        $.ajax({
            url: `/staff_like_reply/${replyId}/`, // Corrected the URL structure
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response) {
                if (response.success) {
                    var likeCount = $('.reply-like-count', '#reply-' + replyId);
                    likeCount.text(response.likeCount);
                }
            }
        });
    }

    // Function to dislike a reply
    function dislikeStaffReply(replyId) {
        $.ajax({
            url: `/staff_dislike_reply/${replyId}/`, // Corrected the URL structure
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response) {
                if (response.success) {
                    var dislikeCount = $('.reply-dislike-count', '#reply-' + replyId);
                    dislikeCount.text(response.dislikeCount);
                }
            }
        });
    }

   // Function to add a reply to a comment
    function addStaffReply(commentId) {
        var replyText = $('#reply-text-' + commentId).val();
        if (replyText.trim() === '') {
            alert('Reply cannot be empty.');
            return;
        }

        $.ajax({
            url: `/add_staff_reply/${commentId}/`, // Correct URL for the reply
            type: 'POST',
            data: {
                'text': replyText,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Append the new reply directly under the comment
                    var newReplyHtml = `
                        <div id="reply-${response.reply_id}" class="reply" style="margin-bottom: 10px;">
                            <strong>${response.username}</strong>: ${response.text}
                            <span class="text-muted" style="font-size: 0.85em;">${response.date}</span>

                            <div style="margin-top: 5px;">
                                <button onclick="likeStaffReply(${response.reply_id})" style="background-color: #28a745; color: white; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px; margin-right: 5px;">
                                    <i class="fas fa-thumbs-up"></i> <span class="reply-like-count">0</span>
                                </button>

                                <button onclick="dislikeStaffReply(${response.reply_id})" style="background-color: #dc3545; color: white; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px; margin-right: 5px;">
                                    <i class="fas fa-thumbs-down"></i> <span class="reply-dislike-count">0</span>
                                </button>

                                {% if response.user == user %}
                                    <button onclick="deleteStaffReply(${response.reply_id})" style="background-color: #ffc107; color: black; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px;">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    `;
                    // Append the new reply under the comment's reply section
                    $('#replies-' + commentId).prepend(newReplyHtml);
                    $('#reply-text-' + commentId).val(''); // Clear the reply text area
                } else {
                    alert('Failed to add reply: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
                alert("An error occurred while adding the reply.");
            }
        });
    }

   // Function to delete a comment
    function deleteStaffComment(commentId) {
        if (confirm("Are you sure you want to delete this comment?")) {
            // Remove the comment from the UI immediately
            $('#comment-' + commentId).fadeOut("slow", function () {
                $(this).remove(); 
            });

            $.ajax({
                url: `/staff_delete_comment/${commentId}/`, 
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success: function(response) {
                    if (!response.success) {
                        alert('Comment could not be deleted. Please try again.'); 
                    
                    }
                },
                error: function() {
                    alert('An error occurred while deleting the comment.');
                }
            });
        }
    }


    // Function to delete a reply
    function deleteStaffReply(replyId) {
        if (confirm("Are you sure you want to delete this reply?")) {
            $.ajax({
                url: `/staff_delete_reply/${replyId}/`, 
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success: function(response) {
                    if (response.success) {
                        // Use fadeOut to animate the removal of the reply
                        $('#reply-' + replyId).fadeOut("slow", function() {
                            $(this).remove(); // Remove the reply after fade-out
                        });
                    } else {
                        alert('Failed to delete reply.');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error:", error);
                    alert("An error occurred while deleting the reply.");
                }
            });
        }
    }


    // Function to load staff comments (updated for AJAX handling)
    function loadStaffComments(postId) {
        $.ajax({
            type: 'GET',
            url: `/load_staff_comments/${postId}/`,  // Corrected URL path for loading comments
            success: function(response) {
                if (response.status === 'success') {
                    $('#comments-container-' + postId).html(response.commentsHtml); 
                }
            },
            error: function(xhr, status, error) {
                console.error("Error loading comments:", status, error);
            }
        });
    }
</script>

{% endblock %}
