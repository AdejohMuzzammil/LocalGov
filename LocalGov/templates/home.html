{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<h1 class="text-center">Local Government Works</h1>
<p class="text-center">View recent posts by chairmen from different states and local governments in Nigeria</p>

<div class="posts-list">
    {% for post in posts %}
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <div>
                <h5 class="card-title">{{ post.title }}</h5>
                <p><strong>State:</strong> {{ post.state.name }} | <strong>Local Government:</strong> {{ post.local_government.name }}</p>
                <p><strong>Location:</strong> {{ post.location }}</p>
                <p class="text-muted">{{ post.date_posted|date:"F j, Y" }}</p>
            </div>
            {% if post.image %}
            <img src="{{ post.image.url }}" alt="Image for {{ post.title }}" class="img-thumbnail" style="width: 100px; height: auto;">
            {% endif %}
        </div>

        <div class="card-body">
            {% if post.video %}
            <video controls class="card-img-top" style="width: 100%; height: 370px;">
                <source src="{{ post.video.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            {% endif %}
            <p class="card-text">{{ post.description }}</p>

            <!-- Map Section -->
            {% if post.latitude and post.longitude %}
            <div class="map-container mt-3">
                <h6>Location Map</h6>
                <div id="map-{{ post.id }}" style="width: 100%; height: 300px;"></div>
                <script>
                    function initMap{{ post.id }}() {
                        var location = { lat: {{ post.latitude }}, lng: {{ post.longitude }} };
                        var map = new google.maps.Map(document.getElementById("map-{{ post.id }}"), {
                            zoom: 10,
                            center: location
                        });
                        new google.maps.Marker({
                            position: location,
                            map: map
                        });
                    }
                    google.maps.event.addDomListener(window, 'load', initMap{{ post.id }});
                </script>
            </div>
            {% endif %}
        </div>

        <!-- Comments Section -->
        <div class="card-footer">
            <button class="btn btn-sm btn-primary" onclick="toggleComments({{ post.id }})">
                <i class="fas fa-comment"></i> Comments
            </button>

            <div id="comments-{{ post.id }}" class="comments-section mt-3" style="display: none;">
                <h6>Comments</h6>

                {% if user.is_authenticated %}
                    <div id="comments-container-{{ post.id }}">
                        {% for comment in post.comments.all %}
                            <div class="comment" id="comment-{{ comment.id }}" style="padding-bottom: 10px; margin-bottom: 15px;">
                                <strong>{{ comment.user.username }}</strong>: {{ comment.text }}
                                <span class="text-muted" style="font-size: 0.9em;">{{ comment.date_commented|date:"F j, Y" }}</span>

                                <div style="margin-top: 10px;">
                                    <button onclick="likeComment({{ comment.id }})" style="background-color: #28a745; color: white; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px; margin-right: 5px;">
                                        <i class="fas fa-thumbs-up"></i> <span class="comment-like-count">{{ comment.like_count.count }}</span>
                                    </button>

                                    <button onclick="dislikeComment({{ comment.id }})" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px; margin-right: 5px;">
                                        <i class="fas fa-thumbs-down"></i> <span class="comment-dislike-count">{{ comment.dislike_count.count }}</span>
                                    </button>

                                    {% if comment.user == user %}
                                        <button onclick="deleteComment({{ comment.id }})" style="background-color: #ffc107; color: black; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px; margin-right: 5px;">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    {% endif %}

                                    <button onclick="toggleReplyForm({{ comment.id }})" style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px;">
                                        <i class="fas fa-reply"></i> Reply
                                    </button>
                                </div>

                                <!-- Reply Form (Initially hidden) -->
                                <div id="reply-form-{{ comment.id }}" style="display: none; margin-top: 10px;">
                                    <textarea id="reply-text-{{ comment.id }}" style="width: 100%; padding: 5px; font-size: 0.85em;" placeholder="Write a reply..."></textarea>
                                    <button onclick="addReply({{ comment.id }})" style="background-color: #007bff; color: white; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px; margin-top: 5px;">Reply</button>
                                </div>

                                <!-- Replies Section -->
                                <div class="replies" style="margin-top: 10px;">
                                    {% for reply in comment.replies.all %}
                                        <div class="reply" id="reply-{{ reply.id }}" style="margin-bottom: 10px;">
                                            <strong>{{ reply.user.username }}</strong>: {{ reply.text }}
                                            <span class="text-muted" style="font-size: 0.85em;">{{ reply.date_commented|date:"F j, Y" }}</span>

                                            <div style="margin-top: 5px;">
                                                <button onclick="likeReply({{ reply.id }})" style="background-color: #28a745; color: white; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px; margin-right: 5px;">
                                                    <i class="fas fa-thumbs-up"></i> <span class="reply-like-count">{{ reply.like_count.count }}</span>
                                                </button>

                                                <button onclick="dislikeReply({{ reply.id }})" style="background-color: #dc3545; color: white; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px; margin-right: 5px;">
                                                    <i class="fas fa-thumbs-down"></i> <span class="reply-dislike-count">{{ reply.dislike_count.count }}</span>
                                                </button>

                                                {% if reply.user == user %}
                                                    <button onclick="deleteReply({{ reply.id }})" style="background-color: #ffc107; color: black; border: none; padding: 3px 8px; font-size: 0.8em; border-radius: 3px;">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>

                                <hr style="border: 1px solid #ddd; margin-top: 15px;">
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Comment Input -->
                    <textarea id="comment-text-{{ post.id }}" style="width: 100%; padding: 5px; font-size: 0.9em; margin-top: 10px;" placeholder="Write a comment..."></textarea>
                    <button onclick="addComment({{ post.id }})" style="background-color: #007bff; color: white; border: none; padding: 5px 10px; font-size: 0.85em; border-radius: 3px; margin-top: 5px;">
                        <i class="fas fa-comment"></i> Comment
                    </button>
                {% else %}
                    <p>You must <a href="{% url 'login' %}">log in</a> to comment.</p>
                {% endif %}
            </div>
        </div>



    </div>
        {% endfor %}
</div>


<script>
    // Function to toggle the visibility of the comments section
    function toggleComments(postId) {
        const commentsSection = document.getElementById(`comments-${postId}`);
        if (commentsSection) {
            commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
        }
    }

    function toggleReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        // Toggle the visibility of the reply form
        replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
    }
    
    // Add Comment
    function addComment(postId) {
        const commentText = document.getElementById(`comment-text-${postId}`).value;
    
        $.ajax({
            type: 'POST',
            url: `/post/${postId}/add_comment/`,
            data: {
                text: commentText,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    const newComment = `<div class="comment" id="comment-${response.comment_id}">
                        <strong>${response.username}</strong>: ${response.text}
                        <span class="text-muted">${response.date}</span>
    
                        <button onclick="likeComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #28a745; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                            <i class="fas fa-thumbs-up" style="margin-right: 5px;"></i> 
                        </button>

                        <button onclick="dislikeComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #dc3545; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                            <i class="fas fa-thumbs-down" style="margin-right: 5px;"></i> 
                        </button>

                        <button onclick="deleteComment(${response.comment_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #ffc107; color: black; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                            <i class="fas fa-trash" style="margin-right: 5px;"></i> Delete
                        </button>

                        <button onclick="toggleReplyForm(${response.comment_id})" class="btn btn-secondary btn-sm">
                            <i class="fas fa-reply"></i> Reply
                        </button>

                        <!-- Comment Reply Form (Initially hidden) -->
                        <div id="reply-form-${response.comment_id}" style="display: none;">
                            <textarea id="reply-text-${response.comment_id}" class="form-control" placeholder="Write a reply..."></textarea>
                            <button onclick="addReply(${response.comment_id})" class="btn btn-primary btn-sm">Reply</button>
                        </div>
                        
                    </div>`;
                    $(`#comments-container-${postId}`).prepend(newComment);
                    document.getElementById(`comment-text-${postId}`).value = '';
                }
            }
        });
    }


    function addReply(commentId) {
        // Get the reply text from the textarea
        const replyText = document.getElementById(`reply-text-${commentId}`).value;
    
        // Make an AJAX POST request to add the reply
        $.ajax({
            type: 'POST',
            url: `/post/${commentId}/add_reply/`, // URL path for adding the reply
            data: {
                text: replyText,  // The reply text
                csrfmiddlewaretoken: '{{ csrf_token }}' // CSRF token for security
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Create the new reply element to display on the page
                    const newReply = `
                        <div class="reply" id="reply-${response.reply_id}">
                            <strong>${response.username}</strong>: ${response.text}
                            <span class="text-muted">${response.date}</span>
    
                            <button onclick="likeReply(${response.reply_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #28a745; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-thumbs-up" style="margin-right: 5px;"></i> 
                            </button>
    
                            <button onclick="dislikeReply(${response.reply_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #dc3545; color: white; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-thumbs-down" style="margin-right: 5px;"></i> 
                            </button>
    
                            <button onclick="deleteReply(${response.reply_id})" style="display: inline-flex; align-items: center; padding: 6px 12px; font-size: 14px; background-color: #ffc107; color: black; border-radius: 4px; border: none; cursor: pointer; margin: 5px; transition: background-color 0.3s ease;">
                                <i class="fas fa-trash" style="margin-right: 5px;"></i> Delete
                            </button>
                        </div>`;
    
                    // Append the new reply under the respective comment's reply section
                    $(`#reply-form-${commentId}`).before(newReply);
    
                    // Clear the reply textarea
                    document.getElementById(`reply-text-${commentId}`).value = '';
                }
            }
        });
    }
    
    // Like and Dislike Comment Functions
    function likeComment(commentId) {
        $.ajax({
            url: `/like_comment/${commentId}/`,
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Update the like and dislike counts for the comment
                    $(`#comment-${commentId} .comment-like-count`).text(response.like_count);
                    $(`#comment-${commentId} .comment-dislike-count`).text(response.dislike_count);
                } else {
                    alert('An error occurred while liking the comment.');
                }
            },
            error: function() {
                alert('An error occurred while processing your request.');
            }
        });
    }

    function dislikeComment(commentId) {
        $.ajax({
            url: `/dislike_comment/${commentId}/`,
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Update the like and dislike counts for the comment
                    $(`#comment-${commentId} .comment-like-count`).text(response.like_count);
                    $(`#comment-${commentId} .comment-dislike-count`).text(response.dislike_count);
                } else {
                    alert('An error occurred while disliking the comment.');
                }
            },
            error: function() {
                alert('An error occurred while processing your request.');
            }
        });
    }
        

    function deleteComment(commentId) {
        $.ajax({
            type: 'POST',
            url: `{% url 'delete_comment' 0 %}`.replace('0', commentId),
            data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function(response) {
                if (response.status === 'success') {
                    $(`#comment-${commentId}`).remove();
                } else {
                    alert(response.message);
                }
            }
        });
    }

 // Like and Dislike Reply Functions
    function likeReply(replyId) {
        $.ajax({
            url: `/like_reply/${replyId}/`,
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Update the like and dislike counts for the reply
                    $(`#reply-${replyId} .reply-like-count`).text(response.like_count);
                    $(`#reply-${replyId} .reply-dislike-count`).text(response.dislike_count);
                } else {
                    alert('An error occurred while liking the reply.');
                }
            },
            error: function() {
                alert('An error occurred while processing your request.');
            }
        });
    }

    function dislikeReply(replyId) {
        $.ajax({
            url: `/dislike_reply/${replyId}/`,
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Update the like and dislike counts for the reply
                    $(`#reply-${replyId} .reply-like-count`).text(response.like_count);
                    $(`#reply-${replyId} .reply-dislike-count`).text(response.dislike_count);
                } else {
                    alert('An error occurred while disliking the reply.');
                }
            },
            error: function() {
                alert('An error occurred while processing your request.');
            }
        });
    }

    function deleteReply(replyId) {
        $.ajax({
            type: 'POST',
            url: `{% url 'delete_reply' 0 %}`.replace('0', replyId),
            data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function(response) {
                if (response.status === 'success') {
                    $(`#reply-${replyId}`).remove();
                } else {
                    alert(response.message);
                }
            }
        });
    }

    // Load Comments
    function loadComments(postId) {
        $.ajax({
            type: 'GET',
            url: `{% url 'load_comments' 0 %}`.replace('0', postId),
            success: function(response) {
                if (response.status === 'success') {
                    $(`#comments-container-${postId}`).html(response.comments_html);
                }
            }
        });
    }
</script>

{% endblock %}
