{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<h1 class="text-center">Local Government Works</h1>
<p class="text-center">View recent posts by chairmen from different states and local governments in Nigeria</p>

<div class="posts-list">
    {% for post in posts %}
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <div>
                <h5 class="card-title">{{ post.title }}</h5>
                <p><strong>State:</strong> {{ post.state.name }} | <strong>Local Government:</strong> {{ post.local_government.name }}</p>
                <p><strong>Location:</strong> {{ post.location }}</p>
                <p class="text-muted">{{ post.date_posted|date:"F j, Y" }}</p>
            </div>
            {% if post.image %}
            <img src="{{ post.image.url }}" alt="Image for {{ post.title }}" class="img-thumbnail" style="width: 100px; height: auto;">
            {% endif %}
        </div>

        <div class="card-body">
            {% if post.video %}
            <video controls class="card-img-top">
                <source src="{{ post.video.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            {% endif %}
            <p class="card-text">{{ post.description }}</p>

            <!-- Map Section -->
            {% if post.latitude and post.longitude %}
            <div class="map-container mt-3">
                <h6>Location Map</h6>
                <div id="map-{{ forloop.counter }}" style="width: 100%; height: 300px;"></div>
                <script>
                    function initMap{{ forloop.counter }}() {
                        var location = { lat: {{ post.latitude }}, lng: {{ post.longitude }} };
                        var map = new google.maps.Map(document.getElementById("map-{{ forloop.counter }}"), {
                            zoom: 10,
                            center: location
                        });
                        new google.maps.Marker({
                            position: location,
                            map: map
                        });
                    }
                    google.maps.event.addDomListener(window, 'load', initMap{{ forloop.counter }});
                </script>
            </div>
            {% endif %}
        </div>

        <!-- Comments Section -->
        <div class="card-footer">
            <button class="btn btn-sm btn-primary" onclick="toggleComments({{ forloop.counter }})">
                View Comments
            </button>

            <!-- Comments Section, hidden by default -->
            <div id="comments-{{ forloop.counter }}" class="comments-section mt-3" style="display: none;">
                <h6>Comments</h6>
                {% for comment in post.comments.all %}
                <div class="comment-container mb-4 p-2 border rounded">
                    <strong>{{ comment.user.username }}:</strong> {{ comment.text }}
                    <span class="text-muted small">{{ comment.date_commented|date:"M j, Y H:i" }}</span>

                    <!-- Like/Dislike buttons for the main comment -->
                    <button id="like-button-{{ comment.id }}" class="btn btn-sm btn-success" onclick="likeComment({{ comment.id }})">
                        <i class="fa fa-thumbs-up"></i> <span id="like-count-{{ comment.id }}">{{ comment.like_count.count }}</span>
                    </button>
                    <button id="dislike-button-{{ comment.id }}" class="btn btn-sm btn-danger" onclick="dislikeComment({{ comment.id }})">
                        <i class="fa fa-thumbs-down"></i> <span id="dislike-count-{{ comment.id }}">{{ comment.dislike_count.count }}</span>
                    </button>

                    <!-- Reply button for the main comment -->
                    <button class="btn btn-sm btn-info" data-toggle="collapse" data-target="#reply-form-{{ comment.id }}">
                        <i class="fa fa-reply"></i> Reply
                    </button>

                    <!-- Reply form for the main comment -->
                    <div id="reply-form-{{ comment.id }}" class="collapse mt-2">
                        <form action="{% url 'reply_comment' post.id comment.id %}" method="post">
                            {% csrf_token %}
                            <textarea name="text" rows="2" class="form-control" placeholder="Write your reply..." required></textarea>
                            <button type="submit" class="btn btn-primary mt-2">Post Reply</button>
                        </form>
                    </div>

                    <!-- Display all replies -->
                {% for reply in comment.replies.all %}
                <div class="reply-container ml-4 mt-2">
                    <strong>{{ reply.user.username }}:</strong> {{ reply.text }}
                    <span class="text-muted small">{{ reply.date_commented|date:"M j, Y H:i" }}</span>

                    <!-- Like/Dislike and Reply buttons for the reply -->
                    <button id="like-button-{{ reply.id }}" class="btn btn-sm btn-success" onclick="likeComment({{ reply.id }}, true)">
                        <i class="fa fa-thumbs-up"></i> <span id="like-count-{{ reply.id }}">{{ reply.like_count.count }}</span>
                    </button>
                    <button id="dislike-button-{{ reply.id }}" class="btn btn-sm btn-danger" onclick="dislikeComment({{ reply.id }}, true)">
                        <i class="fa fa-thumbs-down"></i> <span id="dislike-count-{{ reply.id }}">{{ reply.dislike_count.count }}</span>
                    </button>
                    <button class="btn btn-sm btn-info" data-toggle="collapse" data-target="#reply-to-reply-form-{{ reply.id }}">
                        <i class="fa fa-reply"></i> Reply
                    </button>

                    <div id="reply-to-reply-form-{{ reply.id }}" class="collapse mt-2">
                        <form action="{% url 'reply_to_reply' post.id comment.id reply.id %}" method="post">
                            {% csrf_token %}
                            <textarea name="text" rows="2" class="form-control" placeholder="Write your reply..." required></textarea>
                            <button type="submit" class="btn btn-primary mt-2">Post Reply</button>
                        </form>
                    </div>
                </div>
                {% endfor %}

                </div>

                {% empty %}
                <p>No comments yet. Be the first to comment!</p>
                {% endfor %}

                {% if user.is_authenticated %}
                <form action="{% url 'add_comment' post.id %}" method="post" class="mt-2">
                    {% csrf_token %}
                    <textarea name="text" rows="2" class="form-control" placeholder="Add a comment..." required></textarea>
                    <button type="submit" class="btn btn-primary mt-2">Post Comment</button>
                </form>
                {% else %}
                <p><a href="{% url 'login' %}">Log in</a> to comment on this post.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <p class="no-posts">No posts available.</p>
    {% endfor %}
</div>


<script>
    // Function to toggle the visibility of the comments section
    function toggleComments(counter) {
        const commentsSection = document.getElementById(`comments-${counter}`);
        if (commentsSection) {
            commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
        }
    }

    // Function to handle the like action for a comment or reply
    function likeComment(id, isReply = false) {
        const url = isReply ? `/like-reply/${id}/` : `/like-comment/${id}/`;
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status) {
                // Update like and dislike counts
                updateLikeDislikeCounts(id, isReply, data.like_count, data.dislike_count);
                updateButtonText(id, isReply, "like");
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Function to handle the dislike action for a comment or reply
    function dislikeComment(id, isReply = false) {
        const url = isReply ? `/dislike-reply/${id}/` : `/dislike-comment/${id}/`;
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status) {
                // Update like and dislike counts
                updateLikeDislikeCounts(id, isReply, data.like_count, data.dislike_count);
                updateButtonText(id, isReply, "dislike");
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Helper function to update like and dislike counts dynamically
    function updateLikeDislikeCounts(id, isReply, likeCount, dislikeCount) {
        const likeCountElement = document.getElementById(`like-count-${id}`);
        const dislikeCountElement = document.getElementById(`dislike-count-${id}`);
        if (likeCountElement) likeCountElement.textContent = likeCount;
        if (dislikeCountElement) dislikeCountElement.textContent = dislikeCount;
    }

    // Helper function to update button text based on like/dislike status
    function updateButtonText(id, isReply, action) {
        const likeButton = document.getElementById(`like-button-${id}`);
        const dislikeButton = document.getElementById(`dislike-button-${id}`);
        
        if (action === "like") {
            // Update like button and count
            likeButton.innerHTML = `<i class="fa fa-thumbs-up"></i> <span id="like-count-${id}">${document.getElementById(`like-count-${id}`).textContent}</span>`;
        } else if (action === "dislike") {
            // Update dislike button and count
            dislikeButton.innerHTML = `<i class="fa fa-thumbs-down"></i> <span id="dislike-count-${id}">${document.getElementById(`dislike-count-${id}`).textContent}</span>`;
        }
    }

    // Helper function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>


{% endblock %}
